Resources:
  AcmCertificateXyzGilbertlyApi:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: ${self:custom.ssmPath.xyz_gilbertly_api_domain}
      ValidationMethod: DNS

  Route53HostedZoneXyzGilbertlyApi:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: ${self:custom.ssmPath.xyz_gilbertly_api_domain}
      HostedZoneConfig:
        Comment: ${self:custom.ssmPath.xyz_gilbertly_api_domain}

  Route53RecordSetGroupXyzGilbertlyApi:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: ${self:custom.ssmPath.xyz_gilbertly_api_domain}
      HostedZoneId: '#{Route53HostedZoneXyzGilbertlyApi}'
      RecordSets:
        - Name: ${self:custom.ssmPath.xyz_gilbertly_api_domain}
          Type: A
          AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2 # CloudFront's Magic Number
            DNSName: '#{CloudFrontDistributionXyzGilbertlyApi.DomainName}'

  CloudFrontDistributionComGilbertly:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: '#{GraphQlApi.GraphQLUrl}'
            DomainName: '#{GraphQlApi.GraphQLUrl}'
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginKeepAliveTimeout: 5
              OriginReadTimeout: 30
              OriginProtocolPolicy: https-only
              OriginSSLProtocols: [TLSv1, TLSv1.1, TLSv1.2]
        DefaultCacheBehavior:
          Compress: true
          DefaultTTL: 3600 # 1 hour
          MaxTTL: 86400 # 24 hours
          MinTTL: 60 # 1 minute
          TargetOriginId: '#{GraphQlApi.GraphQLUrl}'
          AllowedMethods: [GET, HEAD, DELETE, POST, PUT]
          ForwardedValues:
            QueryString: false
          SmoothStreaming: false
          ViewerProtocolPolicy: redirect-to-https
        ViewerCertificate:
          AcmCertificateArn: '#{AcmCertificateXyzGilbertlyApi}'
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.1_2016
        Aliases:
          - ${self:custom.ssmPath.xyz_gilbertly_api_domain}
        PriceClass: PriceClass_All
        HttpVersion: http2
        Enabled: true

Outputs:
  Route53HostedZoneXyzGilbertlyApiId:
    Description: Hosted zone id for ${self:custom.ssmPath.xyz_gilbertly_api_domain}.
    Value: '#{Route53HostedZoneXyzGilbertlyApi}'
    Export:
      Name: HostedZoneId-XyzGilbertlyApi
